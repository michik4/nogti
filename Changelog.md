# Changelog

## [2025-01-XX] - Исправления аутентификации

### Исправлено
- **Кодировка кириллических символов**: Убрано base64 кодирование для поля `fullName` в JWT токенах
- **Устаревшие токены**: Добавлена проверка актуальности токенов перед запросами
- **Декодирование токенов**: Улучшена поддержка UTF-8 символов в клиентской части
- **Middleware аутентификации**: Добавлены дополнительные проверки и детальное логирование
- **Инициализация AuthContext**: Улучшена обработка истекших токенов

### Изменено
- `server/src/controllers/auth.controller.ts` - убрано base64 кодирование
- `server/src/utils/jwt.util.ts` - добавлена обработка UTF-8 символов
- `server/src/middleware/auth.middleware.ts` - добавлены проверки и логирование
- `clientapp/src/services/api.ts` - добавлена проверка актуальности токенов
- `clientapp/src/services/authService.ts` - улучшено декодирование токенов
- `clientapp/src/contexts/AuthContext.tsx` - улучшена инициализация

### Добавлено
- Автоматическая очистка некорректных токенов
- Fallback механизмы для стабильной работы
- Детальное логирование для диагностики проблем

## 0.2.2

### Fixed

- **Ошибка декодирования JWT токена** - исправлена проблема `InvalidCharacterError` при декодировании токена
  - Добавлено двойное декодирование base64 (стандартное + URL-безопасное)
  - Улучшена валидация токена перед декодированием
  - Добавлена очистка данных при ошибках декодирования
  - Улучшена обработка ошибок в AuthContext

### Updated

- **authService.ts** - улучшен метод `decodeToken`
  - Добавлена поддержка URL-безопасного base64 декодирования
  - Улучшена обработка ошибок с детальным логированием
  - Добавлена проверка валидности символов в токене

- **jwt.util.ts** - улучшены методы генерации токенов
  - Добавлена очистка строковых значений от пробелов
  - Улучшена типизация для предотвращения ошибок

- **AuthContext.tsx** - добавлена дополнительная обработка ошибок
  - Очистка данных при ошибках получения пользователя
  - Улучшенное логирование ошибок авторизации

### Technical

- **Документация** - создана документация по исправлению JWT токенов
- **Безопасность** - улучшена обработка некорректных токенов

### Files Added

- `clientapp/src/docs/jwt-token-decode-fix.md` - документация по исправлению JWT токенов

## 0.2.1 

### Added 

- setup.sh 
  - создан скрипт для развертывания проекта с помощью pm2

## 0.2.0 

> 30.07.25 20:29\
> 30.07.25 20:56

### Added

- **Улучшения функционала гостевых сессий**
  - Добавлено шифрование данных гостевых сессий в localStorage
  - Реализовано настраиваемое время жизни гостевых сессий
  - Добавлена возможность ручного удаления гостевой сессии
  - Улучшен процесс конвертации гостевого аккаунта в постоянный
  - Добавлены информационные уведомления о гостевых сессиях

### Updated

- **AuthContext** - добавлены методы для управления гостевыми сессиями
  - `createGuestSession(sessionDuration?)` - создание сессии с настраиваемым временем жизни
  - `getGuestSessionTimeLeft()` - получение оставшегося времени жизни сессии
  - `updateGuestData()` - обновление данных гостевого пользователя
  - `clearGuestSession()` - безопасное удаление гостевой сессии

- **GuestSessionManager** - добавлена информационная панель
  - Отображение времени жизни сессии
  - Кнопка ручного удаления сессии
  - Автоматическое уведомление об истечении времени

- **ConvertGuestModal** - улучшен процесс конвертации
  - Добавлено поле для пароля с валидацией (минимум 6 символов)
  - Пошаговый процесс с прогресс-баром
  - Обработка ошибок с возможностью повтора
  - Визуальные состояния: форма → конвертация → успех/ошибка

- **GuestModeNotification** - добавлена информация о сессии
  - Кнопка для показа деталей гостевой сессии
  - Отображение времени жизни сессии
  - Пояснения о локальном хранении данных

### Fixed

- **Ошибка расшифровки гостевых сессий** - исправлена проблема с `InvalidCharacterError` при расшифровке данных
  - Добавлена проверка валидности Base64 строки
  - Улучшена обработка ошибок с fallback механизмом
  - Добавлена миграция старых гостевых данных в новый формат
  - Автоматическое восстановление при некорректных данных

### Security

- **Шифрование данных** - реализовано XOR шифрование с Base64 кодированием
- **Безопасное хранение** - все гостевые данные шифруются перед сохранением
- **Fallback механизм** - автоматическое восстановление при ошибках шифрования

### Technical

- **Типизация** - добавлено поле `sessionDuration` в интерфейс `Guest`
- **Обработка ошибок** - улучшена обработка ошибок во всех операциях
- **Производительность** - оптимизированы интервалы обновления времени жизни
- **Миграция данных** - автоматическая миграция старых гостевых сессий

### Files Added

- `clientapp/src/utils/encryption.util.ts` - утилиты для шифрования данных
- `clientapp/src/docs/guest-sessions-improvements.md` - документация по улучшениям

## 0.1.0 

> 30.07.25 20:22\
> 30.07.25 20:24

### Updated

- Auth page 
  - Добавлена возможность отображать сообщение при редиректе