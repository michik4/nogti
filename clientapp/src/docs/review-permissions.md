# Система разрешений на отзывы

## Обзор

Система разрешений на отзывы обеспечивает контроль доступа к функциональности оставления отзывов на основе роли пользователя и его предыдущей активности.

## Компоненты

### 1. Хук `useReviewPermission`

**Файл:** `src/hooks/useReviewPermission.ts`

Хук для проверки возможности оставления отзыва пользователем.

#### Возвращаемые значения:
- `canReview: boolean` - может ли пользователь оставить отзыв
- `status: ReviewPermissionStatus` - текущий статус разрешения
- `isLoading: boolean` - загружается ли проверка
- `error: string | null` - ошибка проверки

#### Статусы разрешений:
- `loading` - проверка в процессе
- `canReview` - пользователь может оставить отзыв
- `alreadyReviewed` - пользователь уже оставил отзыв
- `notClient` - пользователь не является клиентом
- `notAuthenticated` - пользователь не авторизован
- `error` - произошла ошибка при проверке

### 2. Компонент `ReviewsSummary`

**Файл:** `src/components/ReviewsSummary.tsx`

Обновленный компонент для отображения сводки отзывов с интегрированной формой добавления.

#### Новые пропсы:
- `master: Master` - объект мастера для проверки разрешений
- `onReviewsUpdate?: () => void` - callback для обновления отзывов

#### Функциональность:
- Автоматическая проверка разрешений на отзыв
- Условное отображение формы добавления отзыва
- Отображение статуса разрешения для неавторизованных пользователей
- Интеграция с `AddReviewForm` для создания отзывов

### 3. Компонент `PermissionStatus`

Внутренний компонент для отображения статуса разрешения на отзыв.

#### Состояния:
- **Не авторизован:** "Войдите, чтобы оставить отзыв"
- **Не клиент:** "Только клиенты могут оставлять отзывы"
- **Уже оставил отзыв:** "Вы уже оставили отзыв"
- **Ошибка:** "Ошибка проверки"

## Логика проверки разрешений

### Условия для возможности оставления отзыва:

1. **Авторизация:** Пользователь должен быть авторизован
2. **Роль:** Пользователь должен быть клиентом (`isClient()`)
3. **Отсутствие отзыва:** Пользователь не должен иметь существующий отзыв для данного мастера

### Последовательность проверок:

```typescript
// 1. Проверка аутентификации
if (!currentUser) {
  setStatus('notAuthenticated');
  return;
}

// 2. Проверка роли клиента
if (!isClient()) {
  setStatus('notClient');
  return;
}

// 3. Проверка существования отзыва
const hasReview = await masterRatingService.checkExistReviewAtMaster(masterId);
if (hasReview) {
  setStatus('alreadyReviewed');
} else {
  setStatus('canReview');
}
```

## Интеграция

### В `DesktopProfileView.tsx`:

```typescript
<ReviewsSummary
  isLoading={isLoading}
  ratings={ratings}
  totalReviews={ratings.length}
  onShowAll={() => setShowReviews(true)}
  master={master}
  onReviewsUpdate={handleReviewsUpdate}
/>
```

### В `ReviewsModal.tsx`:

Форма добавления отзыва теперь отображается только в `ReviewsSummary`, что устраняет дублирование логики.

## API Endpoints

### Проверка существования отзыва:
```
GET /api/master-rating/review/check-client/:masterId
```

**Требования:**
- Авторизация: Да
- Роль: client

**Ответ:**
- `200` - отзыв существует
- `404` - отзыв не существует

## UX/UI Особенности

### 1. Состояния загрузки
- Скелетон-лоадеры во время проверки разрешений
- Плавные переходы между состояниями

### 2. Информативные сообщения
- Четкие объяснения почему пользователь не может оставить отзыв
- Иконки для визуального понимания статуса

### 3. Интерактивность
- Кнопка "Оставить отзыв" появляется только при наличии разрешения
- Форма отзыва интегрирована в карточку сводки

## Безопасность

### Серверная валидация:
- Проверка роли пользователя на сервере
- Проверка существования отзыва на сервере
- Защита от дублирования отзывов

### Клиентская валидация:
- Предварительная проверка разрешений
- Условное отображение UI элементов
- Обработка ошибок API

## Тестирование

### Сценарии для тестирования:

1. **Неавторизованный пользователь:**
   - Должен видеть сообщение "Войдите, чтобы оставить отзыв"

2. **Авторизованный мастер:**
   - Должен видеть сообщение "Только клиенты могут оставлять отзывы"

3. **Авторизованный клиент без отзыва:**
   - Должен видеть кнопку "Оставить отзыв"
   - При клике должна открываться форма

4. **Авторизованный клиент с отзывом:**
   - Должен видеть сообщение "Вы уже оставили отзыв"

5. **Ошибка API:**
   - Должно отображаться сообщение об ошибке
   - Возможность повторить попытку

## Будущие улучшения

1. **Кэширование разрешений** для улучшения производительности
2. **Real-time обновления** при изменении статуса пользователя
3. **Аналитика** использования системы отзывов
4. **Модерация отзывов** для предотвращения спама 