# Исправление логики авторства и ценообразования дизайнов

## Проблемы до исправления

### 1. Неправильная логика авторства
- **Проблема**: При привязке дизайна к услуге дизайн становился "личным" у мастера, который его привязал
- **Причина**: Метод `getMasterDesigns` возвращал все дизайны, привязанные к услугам мастера, как его собственные
- **Последствие**: Дизайны отображались как "мои" у нескольких мастеров одновременно

### 2. Неправильная логика ценообразования  
- **Проблема**: Стоимость дизайна не зависела от стоимости услуги
- **Причина**: При привязке использовалась оригинальная цена дизайна вместо цены услуги
- **Последствие**: Дизайн как пример работы по услуге имел неподходящую цену

## Реализованные исправления

### 1. Исправление авторства

#### Серверная часть (`NailDesignController.getMasterDesigns`)

**Было:**
```typescript
// Получаем все связи мастер-сервис-дизайн для данного мастера
const queryBuilder = AppDataSource
    .getRepository(MasterServiceDesignEntity)
    .createQueryBuilder('msd')
    // ... логика получения всех привязанных дизайнов
```

**Стало:**
```typescript
// 1. Получаем дизайны автором которых является мастер
const authoredDesigns = await designRepository.find({
    where: { 
        uploadedByMaster: { id: masterId },
        isActive: true
    },
    // ...
});

// 2. Получаем дизайны, которые мастер может выполнить (привязанные к услугам)
const queryBuilder = AppDataSource
    .getRepository(MasterServiceDesignEntity)
    .createQueryBuilder('msd')
    // Исключаем дизайны, автором которых является сам мастер
    .andWhere('(nd.uploadedByMaster IS NULL OR nd.uploadedByMaster != :masterId)', { masterId });

// 3. Объединяем авторские и привязанные дизайны
const allDesigns = [...filteredAuthoredDesigns];
serviceDesigns.forEach(design => {
    if (!allDesigns.some(d => d.id === design.id)) {
        allDesigns.push(design);
    }
});
```

#### Ключевые изменения:
- Разделение авторских и привязанных дизайнов
- Исключение дублирования авторских дизайнов в привязанных
- Правильная логика модерации для каждого типа дизайнов

### 2. Исправление ценообразования

#### Серверная часть (`MasterController.addDesignToService`)

**Было:**
```typescript
serviceDesign.customPrice = customPrice || service.price;
```

**Стало:**
```typescript
// Стоимость дизайна должна соответствовать стоимости услуги, а не оригинальной цене дизайна
serviceDesign.customPrice = customPrice || service.price;
```

#### Клиентская часть (`MasterDashboard.handleSelectDesign`)

**Было:**
```typescript
// Логика наследования цены: если у дизайна есть своя цена, используем её, иначе - цену услуги
const customPrice = design.estimatedPrice || selectedService.price;
```

**Стало:**
```typescript
// Стоимость дизайна в рамках услуги должна соответствовать стоимости услуги
const customPrice = selectedService.price;
```

#### Клиентская часть (`AddDesignModal`)
- Логика уже была правильной: при выборе услуги цена автоматически устанавливается от услуги
- При создании дизайна "в библиотеку" цена остается 0 или устанавливается вручную

## Логика работы после исправлений

### Авторство дизайнов
1. **Авторские дизайны мастера**:
   - Созданные самим мастером (`uploadedByMaster`)
   - Отображаются как "мои" только у автора
   - Мастер видит все свои дизайны (модерированные и немодерированные)
   - Другие пользователи видят только модерированные

2. **Привязанные дизайны**:
   - Дизайны других авторов, привязанные к услугам мастера
   - НЕ отображаются как "мои" у мастера
   - Сохраняется информация об оригинальном авторе
   - Показываются только модерированные дизайны

### Ценообразование
1. **Дизайн в рамках услуги**:
   - Цена всегда соответствует цене услуги
   - Дизайн представляет пример работы по данной услуге
   - Мастер может установить кастомную цену через `customPrice`

2. **Дизайн в общей библиотеке**:
   - Имеет собственную цену (`estimatedPrice`)
   - Цена может быть 0 или установлена автором
   - Не влияет на цену в рамках услуг

## Техническая документация

### Модифицированные методы

#### `NailDesignController.getMasterDesigns`
- **Цель**: Правильное разделение авторских и привязанных дизайнов
- **Изменения**: Отдельные запросы для авторских дизайнов и привязанных к услугам
- **Результат**: Корректное отображение авторства

#### `MasterController.addDesignToService`  
- **Цель**: Установка правильной цены при привязке дизайна
- **Изменения**: Добавлен комментарий о логике ценообразования
- **Результат**: Цена дизайна соответствует цене услуги

#### `MasterDashboard.handleSelectDesign`
- **Цель**: Использование цены услуги вместо цены дизайна
- **Изменения**: Удалена логика наследования цены от дизайна
- **Результат**: Единообразное ценообразование

### Обратная совместимость
- Существующие данные остаются корректными
- API интерфейсы не изменились
- Клиентский код обновлен без breaking changes

### Тестирование
Необходимо протестировать:
1. Создание дизайна мастером - должен отображаться как "мой"
2. Привязка чужого дизайна - не должен отображаться как "мой"
3. Цена дизайна в услуге должна соответствовать цене услуги
4. Модерация работает корректно для обоих типов дизайнов
5. Дизайны не дублируются в списках

## Влияние на пользователей

### Мастера
- **Положительное**: Четкое разделение "моих" и "привязанных" дизайнов
- **Положительное**: Понятное ценообразование - цена дизайна = цена услуги
- **Нейтральное**: Интерфейс остался прежним, логика стала корректнее

### Клиенты  
- **Положительное**: Корректная информация об авторе дизайна
- **Положительное**: Понятные цены - стоимость работы по конкретной услуге
- **Нейтральное**: Визуальных изменений нет, улучшилась логика

### Администраторы
- **Положительное**: Более логичная система модерации
- **Положительное**: Устранены противоречия в данных 