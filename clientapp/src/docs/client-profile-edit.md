# Форма редактирования профиля клиента

## Обзор

Улучшенная форма редактирования профиля для клиентского дашборда, аналогичная форме в дашборде мастера. Теперь использует актуальные данные с сервера через API эндпоинт `/auth/profile`.

## Компоненты

### EditProfileModal

Основной компонент формы редактирования профиля, расположенный в `clientapp/src/components/EditProfileModal.tsx`.

#### Функциональность

- **Загрузка актуальных данных**: При открытии модального окна загружает актуальные данные профиля с сервера через `authService.getProfile()`
- **Валидация данных**: Проверка обязательных полей (имя, email) и корректности email
- **Загрузка аватара**: Интеграция с AvatarUpload компонентом
- **Обработка ошибок**: Детальная обработка различных типов ошибок
- **Обновление данных**: Автоматическое обновление профиля после сохранения

#### Поля формы

- **Имя** (обязательное): Полное имя пользователя
- **Email** (обязательное): Email адрес с валидацией
- **Телефон**: Номер телефона (необязательное)
- **Местоположение**: Город/район (необязательное)
- **Аватар**: Загрузка изображения профиля

### ClientDashboard

Страница дашборда клиента с интеграцией формы редактирования.

#### Улучшения

- **Загрузка данных с сервера**: Использует `authService.getProfile()` для получения актуальных данных
- **Состояние загрузки**: Показывает индикатор загрузки при получении данных
- **Обновление данных**: Автоматическое обновление после редактирования профиля
- **Обработка ошибок**: Показывает уведомления об ошибках загрузки

### ProfileHeader

Компонент заголовка профиля с отображением обновленных данных.

#### Функциональность

- **Отображение имени пользователя**: С приоритетом серверных данных
- **Обработка русского текста**: Декодирование UTF-8 символов
- **Форматирование дат**: Отображение даты регистрации в формате `день.месяц.год`
- **Отображение местоположения**: Показ города/района пользователя
- **Обновление данных**: После изменения аватара

## API интеграция

### Получение профиля

```typescript
// GET /auth/profile
const profile = await authService.getProfile();
```

### Обновление профиля

```typescript
// PUT /auth/profile
const updateData = {
  fullName: string,
  email: string,
  phone?: string,
  location?: string
};
```

### Обновление аватара

```typescript
// PUT /auth/avatar
// Content-Type: multipart/form-data
const formData = new FormData();
formData.append('avatar', file);
```

## Форматирование дат

### Утилиты форматирования

Добавлены функции в `clientapp/src/utils/format.util.ts`:

```typescript
// Форматирование даты в формате день.месяц.год
export const formatDate = (dateString: string): string => {
  // Возвращает дату в формате "23.07.2025"
};

// Форматирование даты и времени
export const formatDateTime = (dateString: string): string => {
  // Возвращает дату и время в формате "23.07.2025 20:44"
};
```

### Использование

```typescript
import { formatDate } from "@/utils/format.util";

// В компонентах
const joinDate = formatDate(user.createdAt); // "23.07.2025"
```

## Валидация

### Клиентская валидация

- **Имя**: Обязательное поле, не может быть пустым
- **Email**: Обязательное поле, должно соответствовать формату email
- **Телефон**: Необязательное поле
- **Местоположение**: Необязательное поле

### Серверная валидация

- Проверка уникальности email
- Валидация формата данных
- Проверка прав доступа

## Обработка ошибок

### Типы ошибок

1. **Валидация**: Некорректные данные формы
2. **Конфликт**: Email уже используется другим пользователем
3. **Авторизация**: Пользователь не авторизован
4. **Серверные ошибки**: Внутренние ошибки сервера
5. **Ошибки загрузки**: Проблемы с получением данных профиля

### Пользовательские сообщения

- Детальные сообщения об ошибках на русском языке
- Указание конкретной проблемы
- Рекомендации по исправлению

## Обновление данных

### Автоматическое обновление

- При загрузке страницы (через `getProfile()`)
- После сохранения формы
- После изменения аватара
- При закрытии модального окна

### Синхронизация

- Обновление контекста авторизации
- Обновление отображаемых данных
- Синхронизация с сервером

## Состояния загрузки

### Индикаторы загрузки

- **ClientDashboard**: Полноэкранный спиннер при загрузке профиля
- **EditProfileModal**: Спиннер в модальном окне при загрузке данных
- **ProfileHeader**: Обновление данных без блокировки интерфейса

### Обработка состояний

```typescript
const [isLoadingProfile, setIsLoadingProfile] = useState(true);
const [profileData, setProfileData] = useState<User | null>(null);

// Показ загрузки
if (isLoadingProfile && !isGuestUser) {
  return <LoadingSpinner />;
}
```

## Стилизация

### Адаптивный дизайн

- Мобильная версия с вертикальным расположением
- Десктопная версия с горизонтальным расположением
- Адаптивные размеры аватара

### UI компоненты

- Использование shadcn/ui компонентов
- Консистентный дизайн с остальным приложением
- Темная/светлая тема

## Тестирование

### Ручное тестирование

1. Открытие дашборда клиента
2. Проверка загрузки актуальных данных
3. Открытие формы редактирования
4. Заполнение всех полей
5. Валидация обязательных полей
6. Загрузка аватара
7. Сохранение изменений
8. Проверка обновления данных
9. Проверка форматирования дат

### Автоматическое тестирование

- Unit тесты для валидации
- Integration тесты для API
- E2E тесты для пользовательского сценария

## Безопасность

### Защита данных

- Валидация на клиенте и сервере
- Проверка прав доступа
- Защита от XSS атак

### Файловая безопасность

- Ограничение типов файлов
- Ограничение размера файлов
- Проверка содержимого файлов

## Производительность

### Оптимизация

- Ленивая загрузка компонентов
- Кэширование данных профиля
- Оптимизация изображений

### Мониторинг

- Логирование ошибок
- Отслеживание производительности
- Метрики использования

## Изменения в архитектуре

### Переход от JWT к API

- **Раньше**: Данные брались из JWT токена
- **Теперь**: Данные загружаются через `authService.getProfile()`

### Преимущества

- Актуальные данные с сервера
- Возможность обновления данных без перелогина
- Лучшая синхронизация между устройствами
- Более надежная валидация данных

### Обратная совместимость

- Fallback на данные из контекста при ошибках
- Graceful degradation при проблемах с сетью
- Сохранение функциональности для гостевых пользователей 