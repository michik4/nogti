# Улучшения функционала гостевых сессий

## Обзор

Реализованы дополнительные возможности для улучшения безопасности, пользовательского опыта и функциональности гостевых сессий.

## Новые возможности

### 1. Шифрование данных

**Файл:** `clientapp/src/utils/encryption.util.ts`

- **Безопасное хранение** гостевых данных в localStorage
- **XOR шифрование** с Base64 кодированием
- **Fallback механизм** при ошибках шифрования
- **Автоматическое восстановление** при проблемах с расшифровкой

```typescript
// Безопасное сохранение
secureSetItem('guestSession', guestData);

// Безопасное получение
const guestData = secureGetItem('guestSession');
```

### 2. Настраиваемое время жизни сессий

**Файл:** `clientapp/src/contexts/AuthContext.tsx`

- **Гибкое время жизни** - можно задать произвольную длительность
- **Автоматическая очистка** по истечении времени
- **Отслеживание времени** оставшегося до истечения

```typescript
// Создание сессии на 2 часа
createGuestSession(2 * 60 * 60 * 1000);

// Получение оставшегося времени
const timeLeft = getGuestSessionTimeLeft();
```

### 3. Управление гостевой сессией

**Файл:** `clientapp/src/components/GuestSessionManager.tsx`

- **Информационная панель** с временем жизни сессии
- **Ручное удаление** гостевой сессии
- **Автоматическое уведомление** об истечении времени
- **Визуальный индикатор** оставшегося времени

### 4. Улучшенная конвертация аккаунтов

**Файл:** `clientapp/src/components/ConvertGuestModal.tsx`

- **Пошаговый процесс** конвертации с индикаторами
- **Валидация пароля** (минимум 6 символов)
- **Обработка ошибок** с возможностью повтора
- **Прогресс-бар** создания аккаунта
- **Успешное завершение** с автоматическим перенаправлением

### 5. Информационные уведомления

**Файл:** `clientapp/src/components/GuestModeNotification.tsx`

- **Кнопка информации** о гостевой сессии
- **Отображение времени** жизни сессии
- **Пояснения** о локальном хранении данных

## Безопасность

### Шифрование данных

```typescript
// Ключ шифрования (в продакшене должен быть более сложным)
const ENCRYPTION_KEY = 'nogotochki_guest_session_2024';

// Простое XOR шифрование с Base64 кодированием
export const encryptData = (data: string): string => {
  // Реализация шифрования
};
```

### Валидация данных

- **Проверка обязательных полей** при конвертации
- **Валидация пароля** (минимум 6 символов)
- **Проверка email** формата
- **Обработка ошибок** с информативными сообщениями

## Пользовательский опыт

### Визуальные индикаторы

1. **Прогресс конвертации** - показывает этапы создания аккаунта
2. **Время жизни сессии** - отображает оставшееся время
3. **Состояния загрузки** - индикаторы для всех операций
4. **Обработка ошибок** - понятные сообщения об ошибках

### Интерактивные элементы

1. **Кнопка информации** - показывает детали гостевой сессии
2. **Ручное удаление** - возможность удалить сессию вручную
3. **Повтор попытки** - при ошибках конвертации
4. **Скрытие уведомлений** - пользовательский контроль

## Технические улучшения

### Типизация

```typescript
// Добавлено поле для времени жизни сессии
export interface Guest {
  // ... существующие поля
  sessionDuration?: number; // Время жизни сессии в миллисекундах
}
```

### Обработка ошибок

- **Try-catch блоки** во всех критических операциях
- **Fallback механизмы** при сбоях шифрования
- **Информативные сообщения** для пользователя
- **Логирование ошибок** для разработчиков

### Производительность

- **Интервалы обновления** времени жизни (каждую минуту)
- **Автоматическая очистка** истекших сессий
- **Оптимизированные рендеры** компонентов

## Использование

### Создание гостевой сессии

```typescript
const { createGuestSession } = useAuth();

// Стандартная сессия (24 часа)
createGuestSession();

// Кастомная сессия (2 часа)
createGuestSession(2 * 60 * 60 * 1000);
```

### Управление сессией

```typescript
const { 
  getGuestSessionTimeLeft, 
  clearGuestSession, 
  updateGuestData 
} = useAuth();

// Получить оставшееся время
const timeLeft = getGuestSessionTimeLeft();

// Обновить данные гостя
updateGuestData({ name: 'Новое имя' });

// Удалить сессию
clearGuestSession();
```

### Конвертация в постоянный аккаунт

```typescript
const { convertGuestToUser } = useAuth();

try {
  await convertGuestToUser('client', {
    email: 'user@example.com',
    password: 'password123',
    phone: '+79000000000',
    fullName: 'Иван Иванов'
  });
} catch (error) {
  // Обработка ошибки
}
```

## Будущие улучшения

1. **Более надежное шифрование** - использование Web Crypto API
2. **Синхронизация данных** - между вкладками браузера
3. **Экспорт данных** - возможность сохранить гостевые данные
4. **Настройки пользователя** - кастомизация времени жизни по умолчанию
5. **Аналитика** - отслеживание использования гостевых сессий 