# Исправление кодировки полного имени пользователя (fullName)

## Проблема

При передаче полного имени пользователя (`fullName`) с сервера происходила некорректная обработка кириллических символов из-за ненужного кодирования/декодирования в base64.

### Симптомы
- Кириллические имена отображались некорректно в интерфейсе
- Полные имена с русскими символами превращались в нечитаемые последовательности
- Несоответствие между данными из JWT токена и эндпоинта `/auth/profile`

## Причина

Сервер выполнял избыточное кодирование `fullName` в base64 при создании JWT токена:

```typescript
// ❌ Проблемный код в server/src/controllers/auth.controller.ts:
fullName: (user as any).fullName ? Buffer.from((user as any).fullName, 'utf8').toString('base64') : undefined,
```

А клиент пытался декодировать это значение:

```typescript
// ❌ Проблемный код в client/src/services/authService.ts:
if (payload.fullName) {
  try {
    payload.fullName = atob(payload.fullName);
  } catch (e) {
    console.warn('Не удалось декодировать fullName:', e);
  }
}
```

При этом эндпоинт `/auth/profile` возвращал `fullName` напрямую без кодирования, что создавало несоответствие.

## Решение

### 1. Убрано кодирование на сервере

В `server/src/controllers/auth.controller.ts` в методе `generateTokensAndRespond`:

```typescript
// ✅ Исправленный код:
const tokenPayload = {
  userId: user.id,
  email: user.email,
  username: user.username,
  role: user.role,
  isGuest: user.isGuest,
  fullName: (user as any).fullName, // Убираем base64 кодирование
  phone: (user as any).phone,
  avatar: (user as any).avatar
};
```

### 2. Убрано декодирование на клиенте

В `client/src/services/authService.ts` в методе `decodeToken`:

```typescript
// ✅ Исправленный код:
// Декодируем payload
const payload = JSON.parse(atob(base64));

// Удаляем устаревшее декодирование fullName из base64
// Теперь сервер передает fullName в правильной UTF-8 кодировке напрямую

return payload;
```

## Обоснование

### Почему убрали base64 кодирование?

1. **Избыточность**: Современные системы корректно работают с UTF-8 без дополнительного кодирования
2. **Проблемы с кодировкой**: Base64 кодирование/декодирование может искажать кириллические символы
3. **Несогласованность**: JWT и REST API возвращали данные в разных форматах
4. **Сложность**: Дополнительный слой кодирования без реальной необходимости

### Современный подход

- JWT токены должны содержать данные в их естественном виде
- UTF-8 поддерживается повсеместно
- Браузеры корректно обрабатывают кириллицу в JSON

## Результат

### До исправления:
```
JWT: fullName = "0LTQvNC40YLRgNC40Lkg0L" (base64)
API: fullName = "Дмитрий Петров" (UTF-8)
UI:   "0LTQvNC40YLRgNC40Lkg0L" (некорректно)
```

### После исправления:
```
JWT: fullName = "Дмитрий Петров" (UTF-8)
API: fullName = "Дмитрий Петров" (UTF-8)  
UI:  "Дмитрий Петров" (корректно)
```

## Затронутые компоненты

### Серверная часть
- `server/src/controllers/auth.controller.ts` - метод `generateTokensAndRespond`

### Клиентская часть  
- `client/src/services/authService.ts` - метод `decodeToken`
- `client/src/contexts/AuthContext.tsx` - получение корректных данных пользователя
- `client/src/components/home/HeroSection.tsx` - отображение имен пользователей
- `client/src/components/profile/ProfileHeader.tsx` - заголовки профилей

## Обратная совместимость

### Что произойдет с существующими токенами?

Существующие JWT токены с base64-кодированными именами будут:
1. **Декодироваться корректно** - клиент больше не пытается декодировать base64
2. **Отображаться как есть** - если имя было закодировано, оно останется в закодированном виде
3. **Обновляться при следующем входе** - новые токены будут содержать корректные имена

### Миграционная стратегия

Для полного исправления существующих данных:

1. **Немедленно**: Новые входы в систему получат корректные токены
2. **Автоматически**: При вызове `refreshUser()` данные обновятся с сервера  
3. **При необходимости**: Можно добавить endpoint для принудительного обновления токенов

## Тестирование

### Сценарии для проверки:

1. **Новый пользователь с кириллическим именем**
   - Зарегистрироваться с именем "Дмитрий Петров"
   - Проверить корректное отображение в HeroSection
   - Убедиться что JWT токен содержит правильные данные

2. **Существующий пользователь**
   - Войти в систему
   - Проверить отображение имени
   - Вызвать обновление профиля

3. **Авторизация и обновление**
   - Авторизоваться
   - Проверить соответствие JWT и API данных
   - Обновить профиль и проверить консистентность

4. **Различные типы символов**
   - Тестировать с различными кириллическими именами
   - Проверить специальные символы (ё, ъ, ь)
   - Убедиться в корректной обработке пробелов

## Мониторинг

### Логирование для отладки:

```typescript
// В AuthContext при загрузке профиля:
console.log('Профиль загружен с сервера:', profile);

// В HeroSection при получении имени:
const displayName = user.fullName || user.name || user.email;
console.log('Отображаемое имя пользователя:', displayName);
```

### Метрики для отслеживания:

- Количество пользователей с некорректными именами
- Частота обновлений профиля
- Ошибки декодирования в консоли

## Дата исправления

25 января 2025 года

## Дополнительные улучшения

В будущем можно рассмотреть:

1. **Валидация на сервере** - проверка корректности UTF-8 при сохранении
2. **Sanitization** - очистка имен от потенциально опасных символов  
3. **Нормализация** - приведение к единому формату (например, первая буква заглавная)
4. **Миграция базы данных** - исправление уже сохраненных некорректных имен 