# Система записи клиентов к мастерам

## Обзор

Реализована полноценная система записи клиентов к мастерам с проверкой авторизации, ролей пользователей и интеграцией с серверным API заказов.

## Архитектура

### Основные компоненты

1. **BookingModal** (`/components/BookingModal.tsx`) - модальное окно для создания записи
2. **BookingService** (`/services/bookingService.ts`) - сервис для работы с API заказов
3. **Master Profile Views** - компоненты профиля мастера с проверкой ролей
4. **GuestModeNotification** - уведомления для гостевых пользователей

### Проверка ролей и авторизации

Система использует контекст аутентификации для проверки прав доступа:

- **Неавторизованные пользователи** - видят предупреждение о необходимости входа
- **Гостевые пользователи** - получают предложение зарегистрироваться
- **Клиенты** - могут создавать записи
- **Мастера и админы** - кнопки записи скрыты

## API интеграция

### Создание заказа

```typescript
const orderData: CreateOrderData = {
  nailDesignId: string,
  nailMasterId: string,
  requestedDateTime: string, // ISO format
  description?: string,
  clientNotes?: string
};

const response = await bookingService.createOrder(orderData);
```

### Управление заказами

```typescript
// Получение заказов пользователя
await bookingService.getUserOrders(page, limit, status);

// Подтверждение заказа (мастер)
await bookingService.confirmOrder(orderId, price, notes);

// Предложение альтернативного времени (мастер)
await bookingService.proposeAlternativeTime(orderId, newDateTime, notes);

// Отклонение заказа (мастер)
await bookingService.declineOrder(orderId, notes);

// Принятие предложенного времени (клиент)
await bookingService.acceptProposedTime(orderId);
```

## Компоненты

### BookingModal

Модальное окно для создания записи с адаптивным интерфейсом:

```tsx
<BookingModal
  isOpen={boolean}
  onClose={() => void}
  design={DesignObject | null}
  masterId={string}
/>
```

**Функциональность:**
- Проверка авторизации и роли пользователя
- Выбор даты и времени
- Заполнение информации о клиенте (для гостей)
- Интеграция с ConvertGuestModal
- Создание заказа через API

### Master Profile Components

Компоненты профиля мастера с условным отображением кнопок записи:

**DesktopProfileView** - десктопная версия
**MobileProfileView** - мобильная версия

**Логика отображения:**
```typescript
const canBook = !isAuthenticated || isClient() || isGuest();

{canBook && (
  <Button onClick={handleBookingClick}>
    Записаться
  </Button>
)}
```

### GuestModeNotification

Компонент уведомления для гостевых пользователей:

```tsx
<GuestModeNotification
  onDismiss={() => void}
  showOnBookingAttempt={boolean}
/>
```

**Варианты отображения:**
- Общее уведомление о гостевом режиме
- Специальное уведомление при попытке записи

## Состояния заказов

Система поддерживает следующие состояния заказов (OrderStatus):

- `PENDING` - Ожидает ответа мастера
- `CONFIRMED` - Подтверждена мастером
- `ALTERNATIVE_PROPOSED` - Мастер предложил другое время
- `DECLINED` - Отклонена мастером
- `TIMEOUT` - Мастер не ответил в течение 5 минут
- `COMPLETED` - Выполнена
- `CANCELLED` - Отменена

## Пользовательские сценарии

### Сценарий 1: Авторизованный клиент

1. Клиент просматривает профиль мастера
2. Видит кнопки "Записаться" и "Выбрать" у услуг
3. Нажимает на кнопку записи
4. Выбирает дату, время и оставляет комментарии
5. Создается заказ со статусом PENDING
6. Мастер получает уведомление о новом заказе

### Сценарий 2: Гостевой пользователь

1. Гость просматривает профиль мастера
2. Видит уведомление о гостевом режиме
3. Нажимает "Записаться"
4. Система предлагает зарегистрироваться
5. После регистрации может создать заказ

### Сценарий 3: Неавторизованный пользователь

1. Пользователь просматривает профиль мастера
2. Нажимает "Записаться"
3. Получает уведомление о необходимости входа
4. Перенаправляется на страницу авторизации

### Сценарий 4: Мастер или админ

1. Мастер/админ просматривает профиль другого мастера
2. Кнопки записи скрыты
3. При попытке записи получает уведомление об ограничении

## Обработка ошибок

Система включает обработку различных ошибок:

- Проверка обязательных полей
- Валидация ролей пользователей
- Обработка сетевых ошибок
- Уведомления пользователя через toast

## Безопасность

- Все запросы к API заказов требуют авторизации
- Проверка ролей на уровне middleware
- Валидация данных на сервере
- Защита от несанкционированного доступа

## Будущие улучшения

1. Уведомления в реальном времени
2. Календарная интеграция
3. Автоматические напоминания
4. Система отзывов после выполнения заказа
5. Интеграция с платежными системами 