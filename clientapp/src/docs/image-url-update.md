# Исправление кодировки кириллических символов в именах пользователей

## Проблема

При получении полного имени пользователя из JWT payload некорректно обрабатывались кириллические символы, что приводило к их неправильному отображению в интерфейсе.

## Причина

JWT токены кодируют данные в base64, и при декодировании кириллических символов возникали проблемы с кодировкой UTF-8, особенно при прохождении через несколько уровней кодирования/декодирования.

## Решение

### 1. Приоритет серверных данных в AuthContext

Изменена логика инициализации аутентификации для приоритетного использования данных с сервера:

```typescript
// ПРИОРИТЕТ: Получаем актуальные данные с сервера
const profile = await authService.getProfile();
console.log('Профиль загружен с сервера:', profile);
setUser(profile);

// FALLBACK: Только если сервер недоступен, используем данные из токена
// Но предупреждаем о возможных проблемах с кодировкой
```

### 2. Улучшенный метод refreshUser

```typescript
// ПРИОРИТЕТ: Всегда пытаемся получить свежие данные с сервера
const profile = await authService.getProfile();
console.log('Профиль обновлен с сервера:', profile);
setUser(profile);

// МИНИМАЛЬНЫЙ FALLBACK: Используем JWT только в крайнем случае
// и только если текущий пользователь отсутствует
if (!user) {
  console.warn('Попытка загрузки данных из JWT токена как fallback');
  // ... fallback логика
}
```

### 3. Автоматическое обновление в ClientDashboard

Добавлено автоматическое обновление профиля при загрузке страницы:

```typescript
// Обновление профиля при загрузке страницы для получения корректных данных с сервера
useEffect(() => {
  if (currentUser && !isGuest()) {
    console.log('Обновляем профиль пользователя для получения корректных данных с сервера');
    refreshUser().catch(error => {
      console.warn('Не удалось обновить профиль при загрузке страницы:', error);
    });
  }
}, []); // Выполняем только при первой загрузке
```

### 4. Улучшенная логика отображения имени в ProfileHeader

```typescript
// Улучшенная логика получения имени пользователя с приоритетом серверных данных
const displayName = (() => {
  // Для гостевых пользователей используем name
  if (isGuestUser && 'name' in currentUser) {
    return currentUser.name;
  }
  
  // Для авторизованных пользователей приоритет у fullName
  if ('fullName' in currentUser && currentUser.fullName) {
    console.log('Используется fullName из профиля:', currentUser.fullName);
    return currentUser.fullName;
  }
  
  // Fallback на name
  if ('name' in currentUser && currentUser.name) {
    console.log('Используется name из профиля:', currentUser.name);
    return currentUser.name;
  }
  
  // Последний fallback на email
  console.log('Используется email как имя пользователя:', currentUser.email);
  return currentUser.email;
})();
```

## Преимущества решения

### 1. Корректное отображение кириллицы
- Данные с сервера не проходят через дополнительное кодирование JWT
- Кириллические символы отображаются правильно
- UTF-8 кодировка сохраняется

### 2. Надёжность
- Множественные уровни fallback
- Подробное логирование для отладки
- Graceful degradation при недоступности сервера

### 3. Производительность
- Минимизация использования JWT декодирования
- Кэширование данных в AuthContext
- Автоматическое обновление в фоне

## Логирование и отладка

Добавлено подробное логирование для отслеживания источника данных:

- `Профиль загружен с сервера` - данные получены корректно
- `Используются данные из JWT токена. Кириллические символы могут отображаться некорректно` - используется fallback
- `Используется fullName из профиля` - корректное имя из серверных данных

## Тестирование

Для проверки исправления:

1. Создайте пользователя с кириллическим именем
2. Авторизуйтесь и перейдите в профиль
3. Проверьте консоль на наличие логов об источнике данных
4. Убедитесь что кириллические символы отображаются корректно
5. При недоступности сервера проверьте корректность fallback механизма

## Связанные файлы

- `client/src/contexts/AuthContext.tsx` - основная логика аутентификации
- `client/src/pages/dashboard/ClientDashboard.tsx` - автоматическое обновление
- `client/src/components/profile/ProfileHeader.tsx` - отображение имени
- `client/src/services/authService.ts` - получение профиля с сервера

## Дата исправления

25 января 2025 года 