# Документация по тестированию API

## Обзор

Система тестирования покрывает все основные роуты API через реальные HTTP запросы к работающему серверу. Тесты написаны с использованием Jest и Supertest для максимальной достоверности результатов.

## Структура тестов

### Файлы тестов

- `__tests__/auth.test.ts` - Тестирование аутентификации
- `__tests__/designs.test.ts` - Тестирование роутов дизайнов
- `__tests__/masters.test.ts` - Тестирование роутов мастеров  
- `__tests__/orders.test.ts` - Тестирование роутов заказов
- `__tests__/helpers/test.helper.ts` - Вспомогательные функции
- `__tests__/setup.ts` - Настройка тестового окружения

### Вспомогательные инструменты

**TestHelper** предоставляет методы для:
- Создания тестовых пользователей (клиенты, мастера, администраторы)
- Создания тестовых дизайнов
- Генерации JWT токенов
- Очистки тестовых данных после выполнения

## Команды запуска

### CLI утилита для тестов (рекомендуемый способ)

```bash
# Показать справку по CLI
npm run cli test help

# Запуск всех тестов
npm run cli test run

# Запуск в режиме наблюдения
npm run cli test watch

# Анализ покрытия кода
npm run cli test coverage

# Очистка тестовых данных
npm run cli test clean

# Проверка окружения
npm run cli test setup

# Статус тестовой системы
npm run cli test status

# Запуск конкретного файла
npm run cli test run --file auth.test.ts

# Запуск с дополнительными опциями
npm run cli test run --verbose --bail
npm run cli test watch --file designs.test.ts
npm run cli test coverage --silent
```

### Стандартные команды

```bash
# Запуск всех тестов
npm test

# Запуск с наблюдением за изменениями
npm run test:watch

# Запуск с покрытием кода
npm run test:coverage

# Детальный вывод
npm run test:verbose

# Запуск конкретного файла тестов
npm test auth.test.ts
npm test designs.test.ts
npm test masters.test.ts
npm test orders.test.ts
```

## Покрытие тестами

### Аутентификация (auth.test.ts)

**POST /api/auth/register**
- ✅ Регистрация нового клиента
- ✅ Регистрация нового мастера
- ✅ Отклонение дублирующегося email
- ✅ Отклонение неполных данных

**POST /api/auth/login**
- ✅ Авторизация клиента по email
- ✅ Авторизация мастера по телефону
- ✅ Отклонение неверного пароля
- ✅ Отклонение несуществующего пользователя

**POST /api/auth/refresh**
- ✅ Обновление токенов
- ✅ Отклонение неверного refresh token
- ✅ Отклонение запроса без токена

### Дизайны (designs.test.ts)

**GET /api/designs**
- ✅ Получение списка без авторизации
- ✅ Фильтрация по типу, источнику, цвету
- ✅ Поиск по тегам
- ✅ Пагинация

**GET /api/designs/:id**
- ✅ Получение конкретного дизайна
- ✅ Ошибка для несуществующего дизайна

**POST /api/designs/:id/like**
- ✅ Лайк от авторизованного клиента
- ✅ Удаление лайка при повторном запросе
- ✅ Отклонение без авторизации
- ✅ Отклонение от мастера

**POST /api/designs**
- ✅ Создание дизайна клиентом
- ✅ Создание дизайна мастером
- ✅ Отклонение без авторизации
- ✅ Отклонение неполных данных

**GET /api/designs/:id/masters**
- ✅ Поиск мастеров с геолокацией
- ✅ Требование координат
- ✅ Ошибка для несуществующего дизайна

### Мастера (masters.test.ts)

**POST /api/masters/can-do/:designId**
- ✅ Добавление дизайна в список "Я так могу"
- ✅ Отклонение дублирующегося дизайна
- ✅ Отклонение запроса от клиента
- ✅ Отклонение без авторизации
- ✅ Отклонение несуществующего дизайна

**DELETE /api/masters/can-do/:designId**
- ✅ Удаление дизайна из списка
- ✅ Отклонение несуществующего дизайна

**GET /api/masters/my-designs**
- ✅ Получение списка дизайнов мастера
- ✅ Пагинация
- ✅ Отклонение запроса от клиента

**PUT /api/masters/can-do/:designId**
- ✅ Обновление информации о дизайне
- ✅ Отклонение несуществующего дизайна

**GET /api/masters/profile/:id**
- ✅ Получение профиля мастера по ID
- ✅ Ошибка для несуществующего мастера

**GET /api/masters/profile**
- ✅ Получение своего профиля авторизованным мастером
- ✅ Отклонение без авторизации
- ✅ Отклонение запроса от клиента

**PUT /api/masters/profile**
- ✅ Обновление профиля мастера
- ✅ Отклонение дублирующегося телефона
- ✅ Отклонение запроса от клиента

**GET /api/masters/nearby**
- ✅ Поиск мастеров по геолокации
- ✅ Расчет расстояния
- ✅ Отклонение запроса без координат
- ✅ Значения по умолчанию

### Заказы (orders.test.ts)

**POST /api/orders**
- ✅ Создание нового заказа
- ✅ Отклонение без авторизации
- ✅ Отклонение запроса от мастера

**PUT /api/orders/:id/confirm**
- ✅ Подтверждение заказа мастером
- ✅ Отклонение подтверждения клиентом

**GET /api/orders**
- ✅ Получение списка заказов клиента
- ✅ Получение списка заказов мастера
- ✅ Отклонение без авторизации

## Особенности реализации

### Изоляция тестов
- Каждый тест создает собственные тестовые данные
- Автоматическая очистка после выполнения
- Независимость тестов друг от друга

### Реальные HTTP запросы
- Тесты используют реальный Express сервер
- Полная проверка middleware, роутинга и контроллеров
- Тестирование авторизации с JWT токенами

### Проверка ответов API
- Валидация структуры ответов
- Проверка статус-кодов
- Тестирование полей success/error согласно стандартам

### База данных
- Использование реальной базы данных
- Транзакции для изоляции (планируется)
- Автоматическая миграция схемы

## Конфигурация

**jest.config.js**
- Настройка TypeScript
- Таймауты для async операций
- Настройка покрытия кода
- Исключение файлов из анализа

**setup.ts**
- Инициализация подключения к БД
- Graceful shutdown
- Обработка unhandled rejections

## Рекомендации по запуску

1. **Первоначальная настройка:**
   ```bash
   # Проверьте готовность тестового окружения
   npm run cli test setup
   
   # Убедитесь что база данных доступна
   npm run cli test status
   ```

2. **Для разработки:**
   ```bash
   # Используйте CLI в watch режиме
   npm run cli test watch --verbose
   
   # Работа над конкретным модулем
   npm run cli test watch --file auth.test.ts
   ```

3. **Для CI/CD:**
   ```bash
   # Запуск с покрытием и остановкой при первой ошибке
   npm run cli test coverage --bail
   ```

4. **Отладка и очистка:**
   ```bash
   # Детальный вывод
   npm run cli test run --verbose
   
   # Очистка тестовых данных при проблемах
   npm run cli test clean
   ```

5. **Быстрые проверки:**
   ```bash
   # Быстрый запуск без лишнего вывода
   npm run cli test run --silent --bail
   ```

## Планы развития

- [ ] Добавление интеграционных тестов
- [ ] Тестирование производительности
- [ ] Моки для внешних сервисов
- [ ] Тестирование WebSocket соединений
- [ ] Автоматическая генерация тестовых данных
- [ ] Параллельное выполнение тестов 