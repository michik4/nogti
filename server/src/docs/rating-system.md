# Система рейтингов мастеров

## Обзор

Система рейтингов автоматически обновляет рейтинг мастера на основе отзывов клиентов. При добавлении нового отзыва происходит пересчет среднего рейтинга и обновление количества отзывов.

## Структура данных

### MasterRatingEntity
```typescript
{
  id: string;              // UUID отзыва
  ratingNumber: number;    // Оценка от 1 до 5
  description: string;     // Текст отзыва
  createdAt: Date;         // Дата создания
  nailMaster: NailMasterEntity;  // Связь с мастером
  client: ClientEntity;    // Связь с клиентом
}
```

### NailMasterEntity (поля рейтинга)
```typescript
{
  rating: number;          // Средний рейтинг (с точностью до 0.1)
  reviewsCount: number;    // Общее количество отзывов
  // ... другие поля
}
```

## Автоматический пересчет рейтинга

### Когда происходит пересчет
- При добавлении нового отзыва через `ClientController.sendReview`
- Можно вызвать вручную через утилиту `recalculateMasterRating(masterId)`

### Алгоритм расчета
1. Загружаются все отзывы мастера
2. Вычисляется среднее арифметическое всех оценок
3. Результат округляется до 1 знака после запятой
4. Подсчитывается общее количество отзывов
5. Обновляются поля `rating` и `reviewsCount` в сущности мастера

### Пример расчета
```
Отзывы: [5, 4, 5, 3, 4]
Средний рейтинг: (5 + 4 + 5 + 3 + 4) / 5 = 4.2
Количество отзывов: 5
```

## API для работы с отзывами

### Добавление отзыва
```
POST /api/master-rating/
Authorization: Bearer <token>
Content-Type: application/json

{
  "masterId": "uuid-мастера",
  "ratingNumber": 5,
  "description": "Отличная работа!"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "id": "uuid-отзыва",
    "ratingNumber": 5,
    "description": "Отличная работа!",
    "createdAt": "2024-01-20T10:00:00.000Z"
  },
  "message": "Отзыв оставлен"
}
```

### Редактирование отзыва
```
PUT /api/master-rating/{reviewId}
Authorization: Bearer <token>
Content-Type: application/json

{
  "ratingNumber": 4,
  "description": "Хорошая работа, но есть замечания"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "id": "uuid-отзыва",
    "ratingNumber": 4,
    "description": "Хорошая работа, но есть замечания",
    "createdAt": "2024-01-20T10:00:00.000Z"
  },
  "message": "Отзыв обновлен"
}
```

### Удаление отзыва
```
DELETE /api/master-rating/{reviewId}
Authorization: Bearer <token>
```

**Ответ:**
```json
{
  "success": true,
  "message": "Отзыв удален"
}
```

### Получение отзывов мастера
```
GET /api/master-rating/{masterId}?page=1&limit=20
```

**Ответ:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-отзыва",
      "ratingNumber": 5,
      "description": "Отличная работа!",
      "createdAt": "2024-01-20T10:00:00.000Z",
      "client": {
        "id": "uuid-клиента",
        "fullName": "Имя клиента"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 1,
    "totalPages": 1
  }
}
```

### Проверка существования отзыва
```
GET /api/master-rating/review/check-client/{masterId}
Authorization: Bearer <token>
```

## Редактирование и удаление отзывов

### Права доступа
- **Редактирование**: Только автор отзыва может его редактировать
- **Удаление**: Только автор отзыва может его удалить
- **Проверка авторства**: Система автоматически проверяет, что пользователь является автором отзыва

### Автоматический пересчет рейтинга
При редактировании или удалении отзыва автоматически происходит:
1. Обновление/удаление записи в базе данных
2. Пересчет среднего рейтинга мастера
3. Обновление количества отзывов

### Безопасность
- Проверка авторизации пользователя
- Проверка роли (только клиенты)
- Проверка авторства отзыва
- Валидация данных при обновлении

### Клиентская часть
- Кнопки "Редактировать" и "Удалить" видны только для своих отзывов
- Форма автоматически переключается в режим редактирования
- Подтверждение перед удалением отзыва
- Автоматическое обновление интерфейса после изменений

## Ограничения

1. **Один отзыв на мастера**: Каждый клиент может оставить только один отзыв для каждого мастера
2. **Диапазон оценок**: От 1 до 5 звезд
3. **Автоматическое обновление**: Рейтинг обновляется сразу после добавления/изменения/удаления отзыва
4. **Точность**: Рейтинг округляется до 1 знака после запятой
5. **Права редактирования**: Только автор может редактировать или удалять свой отзыв

## Утилиты для работы с рейтингом

### recalculateMasterRating(masterId: string)
Пересчитывает и обновляет рейтинг мастера на основе всех его отзывов.

```typescript
import { recalculateMasterRating } from '../utils/rating.util';

await recalculateMasterRating('uuid-мастера');
```

### getMasterRatingStats(masterId: string)
Получает подробную статистику рейтингов мастера.

```typescript
import { getMasterRatingStats } from '../utils/rating.util';

const stats = await getMasterRatingStats('uuid-мастера');
// Возвращает:
// {
//   averageRating: 4.2,
//   reviewsCount: 5,
//   ratingDistribution: [0, 0, 1, 2, 2] // количество оценок 1-5
// }
```

## Безопасность

- Только авторизованные клиенты могут оставлять отзывы
- Проверка роли пользователя (только клиенты)
- Валидация UUID мастера
- Защита от дублирования отзывов

## Логирование

Система логирует:
- Успешное добавление отзывов
- Ошибки при пересчете рейтинга
- Результаты пересчета рейтинга

```
[ClientController] Рейтинг мастера uuid-мастера успешно пересчитан
[Rating Util] Обновлен рейтинг мастера uuid-мастера: 4.2 (5 отзывов)
``` 