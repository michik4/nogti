# Система полного удаления дизайнов

## Обзор

Система полного удаления дизайнов обеспечивает безопасное удаление дизайнов из базы данных с сохранением информации о дизайнах в существующих заказах.

## Архитектура

### Сущности

1. **OrderDesignSnapshotEntity** - снимок дизайна для сохранения в заказе
2. **OrderEntity** - обновлена для поддержки снимков дизайнов
3. **NailDesignEntity** - основная сущность дизайна

### Утилиты

1. **DesignSnapshotUtil** - создание снимков дизайнов
2. **OrderDesignUtil** - получение информации о дизайне из заказа

## Процесс удаления дизайна

### 1. Создание снимков для существующих заказов

При удалении дизайна система:
- Находит все заказы, использующие этот дизайн
- Создает снимок дизайна для каждого заказа
- Обновляет заказы для использования снимка вместо ссылки на дизайн

### 2. Удаление связей

Система удаляет:
- Связи дизайна с услугами мастеров (MasterServiceDesignEntity)
- Лайки дизайна от клиентов
- Сам дизайн из базы данных

### 3. Транзакционность

Весь процесс выполняется в транзакции для обеспечения целостности данных.

## Создание новых заказов

При создании нового заказа:
- Если указан дизайн, создается снимок дизайна
- Заказ сохраняется со ссылкой на снимок
- Счетчик заказов дизайна увеличивается

## Получение информации о дизайне

При получении заказа система:
- Проверяет наличие снимка дизайна (приоритет)
- Если снимка нет, использует связь с дизайном
- Возвращает унифицированную информацию о дизайне

## API Endpoints

### DELETE /api/designs/:id
Полное удаление дизайна из системы.

**Права доступа:**
- Админ
- Автор дизайна

**Ответ:**
```json
{
  "success": true,
  "message": "Дизайн полностью удален из системы"
}
```

## Безопасность

- Проверка прав доступа перед удалением
- Транзакционность операций
- Сохранение исторических данных в заказах
- Откат изменений при ошибках

## Миграции

Необходимо выполнить миграцию для создания таблицы `order_design_snapshots`:

 ```sql
 CREATE TABLE "order_design_snapshots" (
   "id" uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
   "title" varchar(255) NOT NULL,
   "description" text,
   "imageUrl" varchar(500) NOT NULL,
   "videoUrl" varchar(500),
   "type" design_type_enum DEFAULT 'basic',
   "source" design_source_enum NOT NULL,
   "tags" json,
   "color" varchar(100),
   "originalDesignId" varchar(255),
   "authorName" varchar(255),
   "authorId" varchar(255),
   "createdAt" timestamp DEFAULT now()
 );
 ```

## Совместимость

Система обеспечивает обратную совместимость:
- Существующие заказы продолжают работать
- Новые заказы используют снимки дизайнов
- API остается совместимым 