# Тестирование системы учета занятых окон

## Обзор

Данный документ описывает тестирование новой функциональности автоматического учета занятых окон в системе расписания мастеров.

## Тестовые сценарии

### 1. Базовое скрытие занятых окон

**Цель:** Проверить, что окна с подтвержденными заказами не отображаются в расписании.

**Шаги:**
1. Создать временное окно на 15:00-16:00
2. Создать заказ на это время со статусом `CONFIRMED`
3. Получить расписание мастера
4. Проверить, что окно 15:00-16:00 отсутствует в списке

**Ожидаемый результат:** Окно с подтвержденным заказом не отображается в расписании.

### 2. Блокировка соседних часов при длительности > 60 минут

**Цель:** Проверить автоматическую блокировку соседних часовых окон.

**Тестовые случаи:**

#### Случай 2.1: Услуга 90 минут
1. Создать услугу с длительностью 90 минут
2. Создать заказ на 14:00 с этой услугой
3. Получить расписание
4. Проверить, что заблокированы окна: 14:00, 15:00

#### Случай 2.2: Услуга 120 минут
1. Создать услугу с длительностью 120 минут
2. Создать заказ на 10:00 с этой услугой
3. Получить расписание
4. Проверить, что заблокированы окна: 10:00, 11:00, 12:00

#### Случай 2.3: Услуга 60 минут
1. Создать услугу с длительностью 60 минут
2. Создать заказ на 16:00 с этой услугой
3. Получить расписание
4. Проверить, что заблокировано только окно 16:00

### 3. Проверка различных статусов заказов

**Цель:** Убедиться, что учитываются только нужные статусы заказов.

**Тестовые случаи:**

#### Случай 3.1: Заказ со статусом PENDING
1. Создать заказ со статусом `PENDING`
2. Получить расписание
3. Проверить, что окно не заблокировано

#### Случай 3.2: Заказ со статусом CONFIRMED
1. Создать заказ со статусом `CONFIRMED`
2. Получить расписание
3. Проверить, что окно заблокировано

#### Случай 3.3: Заказ со статусом COMPLETED
1. Создать заказ со статусом `COMPLETED`
2. Получить расписание
3. Проверить, что окно заблокировано

### 4. Проверка API endpoints

#### 4.1. GET /api/masters/:masterId/schedule

**Тест:**
```bash
curl -X GET "http://localhost:3000/api/masters/{masterId}/schedule" \
  -H "Authorization: Bearer {token}"
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-01-15",
      "timeSlots": [
        {
          "id": "uuid",
          "startTime": "09:00",
          "endTime": "10:00",
          "status": "available"
        }
      ]
    }
  ]
}
```

#### 4.2. GET /api/masters/:masterId/schedule/available

**Тест:**
```bash
curl -X GET "http://localhost:3000/api/masters/{masterId}/schedule/available?date=2024-01-15" \
  -H "Authorization: Bearer {token}"
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "startTime": "09:00",
      "endTime": "10:00",
      "status": "available"
    }
  ]
}
```

### 5. Проверка граничных случаев

#### Случай 5.1: Переход через полночь
1. Создать заказ на 23:00 с длительностью 120 минут
2. Проверить, что заблокированы окна: 23:00, 00:00

#### Случай 5.2: Множественные заказы в один день
1. Создать заказ на 10:00 (60 мин)
2. Создать заказ на 14:00 (90 мин)
3. Получить расписание
4. Проверить, что заблокированы окна: 10:00, 14:00, 15:00

#### Случай 5.3: Заказ без confirmedDateTime
1. Создать заказ без поля `confirmedDateTime`
2. Получить расписание
3. Проверить, что окна не заблокированы

## Автоматизированные тесты

### Unit тесты для ScheduleController

```typescript
describe('ScheduleController - Occupied Slots', () => {
  it('should hide slots with confirmed orders', async () => {
    // Тест скрытия занятых окон
  });

  it('should block adjacent hours for orders > 60 minutes', async () => {
    // Тест блокировки соседних часов
  });

  it('should only consider CONFIRMED and COMPLETED orders', async () => {
    // Тест фильтрации по статусам
  });
});
```

### Integration тесты

```typescript
describe('Schedule API Integration', () => {
  it('should return filtered schedule', async () => {
    // Интеграционный тест API
  });

  it('should handle multiple orders correctly', async () => {
    // Тест множественных заказов
  });
});
```

## Метрики производительности

### Тестирование производительности

1. **Время ответа API:**
   - Без заказов: < 100ms
   - С 100 заказами: < 200ms
   - С 1000 заказами: < 500ms

2. **Использование памяти:**
   - Проверить отсутствие утечек памяти при обработке больших объемов данных

3. **Масштабируемость:**
   - Тест с 10,000 заказов
   - Тест с 100 мастерами одновременно

## Чек-лист тестирования

### Функциональное тестирование
- [ ] Базовое скрытие занятых окон
- [ ] Блокировка соседних часов при длительности > 60 минут
- [ ] Учет только CONFIRMED и COMPLETED заказов
- [ ] Корректная работа с различными длительностями услуг
- [ ] Обработка граничных случаев (полночь, множественные заказы)

### API тестирование
- [ ] GET /api/masters/:masterId/schedule
- [ ] GET /api/masters/schedule (для текущего мастера)
- [ ] GET /api/masters/:masterId/schedule/available
- [ ] Корректные HTTP статусы
- [ ] Правильная структура ответов

### Производительность
- [ ] Время ответа в пределах нормы
- [ ] Отсутствие утечек памяти
- [ ] Корректная работа при большой нагрузке

### Безопасность
- [ ] Авторизация для защищенных endpoints
- [ ] Валидация входных данных
- [ ] Защита от SQL инъекций

## Отладка

### Логи для отладки

```typescript
// В ScheduleController
console.log('Orders found:', orders.length);
console.log('Occupied slots:', occupiedSlots);
console.log('Filtered schedules:', filteredSchedules.length);
```

### Инструменты для отладки

1. **Postman/Insomnia** - для тестирования API
2. **Database queries** - для проверки данных
3. **Browser DevTools** - для клиентской отладки
4. **Server logs** - для серверной отладки

## Известные ограничения

1. **Точность времени:** Система работает с часовыми интервалами
2. **Часовой пояс:** Все времена в локальном часовом поясе
3. **Производительность:** При большом количестве заказов может потребоваться оптимизация

## Рекомендации по тестированию

1. **Начните с простых случаев** - базовое скрытие окон
2. **Постепенно усложняйте** - добавьте длительные заказы
3. **Тестируйте граничные случаи** - полночь, множественные заказы
4. **Проверьте производительность** - с большими объемами данных
5. **Протестируйте API** - все endpoints с различными параметрами 