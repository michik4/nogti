# Управление расписанием мастера

## Обзор

Система управления расписанием позволяет мастерам создавать временные окна для записи клиентов и автоматически синхронизирует их статус с заказами.

## Статусы временных окон

- `available` - Доступно для записи
- `booked` - Забронировано для заказа
- `blocked` - Заблокировано мастером

## Автоматическая синхронизация с заказами

### При подтверждении заказа
Когда мастер подтверждает заказ (`confirmOrder`):
1. Статус заказа меняется на `CONFIRMED`
2. Временное окно автоматически блокируется (статус `booked`)
3. В окне сохраняется ссылка на заказ в поле `notes`

### При принятии предложенного времени
Когда клиент принимает предложенное мастером время (`acceptProposedTime`):
1. Статус заказа меняется на `CONFIRMED`
2. Временное окно для предложенного времени блокируется
3. В окне сохраняется ссылка на заказ

### При отмене заказа
Когда заказ отменяется (`cancelOrder`):
1. Если заказ был подтвержден, временное окно разблокируется
2. Статус окна возвращается к `available`
3. Поле `notes` очищается

### При отклонении заказа
Когда мастер отклоняет заказ (`declineOrder`):
1. Если заказ был подтвержден, временное окно разблокируется
2. Статус окна возвращается к `available`

### При завершении заказа
Когда мастер завершает заказ (`completeOrder`):
1. Временное окно разблокируется
2. Статус окна возвращается к `available`
3. Окно снова становится доступным для новых записей

## API Endpoints

### Получение расписания мастера
```
GET /api/schedule/master/:masterId
```

### Получение доступных окон
```
GET /api/schedule/available/:masterId?date=YYYY-MM-DD
```

### Добавление временного окна
```
POST /api/schedule/slot
```

### Обновление временного окна
```
PUT /api/schedule/slot/:slotId
```

### Удаление временного окна
```
DELETE /api/schedule/slot/:slotId
```

### Блокировка временного окна
```
POST /api/schedule/block/:masterId/:slotId
```

### Разблокировка временного окна
```
POST /api/schedule/unblock/:masterId/:slotId
```

## Утилиты

### ScheduleUtil

Класс `ScheduleUtil` содержит методы для работы с временными окнами:

- `blockTimeSlotForOrder(order)` - Блокирует временное окно для заказа
- `blockTimeSlotForProposedTime(order)` - Блокирует временное окно для предложенного времени
- `unblockTimeSlotForOrder(order)` - Разблокирует временное окно для заказа

## Логика фильтрации доступных окон

В методе `getAvailableSlots` учитываются:
1. Временные окна со статусом `available`
2. Подтвержденные заказы (`CONFIRMED`)
3. Завершенные заказы (`COMPLETED`)
4. Длительность услуг (для блокировки соседних часов)

## Примеры использования

### Создание временного окна
```typescript
const timeSlot = new ScheduleEntity();
timeSlot.nailMaster = master;
timeSlot.workDate = new Date('2024-01-15');
timeSlot.startTime = '10:00';
timeSlot.endTime = '11:00';
timeSlot.status = ScheduleStatus.AVAILABLE;
```

### Блокировка окна при подтверждении заказа
```typescript
await ScheduleUtil.blockTimeSlotForOrder(order);
```

### Разблокировка окна при отмене заказа
```typescript
await ScheduleUtil.unblockTimeSlotForOrder(order);
``` 